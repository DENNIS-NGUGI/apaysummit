<!DOCTYPE html>
{% load custom_filters %}
<html>
<head>
    <meta charset="utf-8">
    <title>Participants Report - Apay Summit</title>
    <style>
        @page {
            size: a4 landscape;
            margin: 1cm;
            
            @frame header {
                -pdf-frame-content: header-content;
                left: 1cm; width: 27cm; top: 0.5cm; height: 2.5cm;
            }
            
            @frame content {
                left: 1cm; width: 27cm; top: 3.5cm; height: 15cm;
            }
            
            @frame footer {
                -pdf-frame-content: footer-content;
                left: 1cm; width: 27cm; top: 19cm; height: 1.5cm;
            }
        }
        
        body {
            font-family: "Helvetica", "Arial", sans-serif;
            font-size: 8pt;
            line-height: 1.2;
            color: #000000;
            margin: 0;
            padding: 0;
        }
        
        .header {
            text-align: center;
            border-bottom: 1.5pt solid #dc3545;
            padding-bottom: 6pt;
            margin-bottom: 8pt;
        }
        
        .logo {
            height: 30pt;
            margin-bottom: 3pt;
        }
        
        .title {
            font-size: 16pt;
            font-weight: bold;
            color: #000000;
            margin: 2pt 0;
        }
        
        .subtitle {
            font-size: 10pt;
            color: #dc3545;
            font-weight: bold;
        }
        
        .summary {
            background: #f8f9fa;
            padding: 6pt;
            margin: 8pt 0;
            border-left: 3pt solid #dc3545;
            font-size: 8pt;
            border-radius: 3pt;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 6pt 0;
            font-size: 7pt;
            table-layout: fixed;
        }
        
        th {
            background: #dc3545;
            color: white;
            font-weight: bold;
            padding: 5pt 3pt;
            border: 1pt solid #b02a37;
            text-align: left;
        }
        
        td {
            padding: 4pt 3pt;
            border: 1pt solid #dee2e6;
            text-align: left;
            vertical-align: top;
            word-wrap: break-word;
            word-break: break-word;
        }
        
        tr.alt {
            background-color: #f8f9fa;
        }
        
        .badge {
            padding: 1pt 3pt;
            border-radius: 2pt;
            font-size: 6pt;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .badge-success { background: #198754; color: white; }
        .badge-warning { background: #ffc107; color: black; }
        .badge-danger { background: #dc3545; color: white; }
        .badge-info { background: #0dcaf0; color: black; }
        .badge-secondary { background: #6c757d; color: white; }
        .badge-primary { background: #0d6efd; color: white; }
        
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .text-muted { color: #6c757d; font-size: 6pt; }
        
        .footer {
            text-align: center;
            font-size: 7pt;
            color: #666666;
            border-top: 1pt solid #dc3545;
            padding-top: 4pt;
        }
        
        .total-row {
            background: #000000 !important;
            color: white;
            font-weight: bold;
        }
        
        .total-row td {
            border-color: #333333;
        }
        
        .compact-text {
            font-size: 7pt;
            line-height: 1.1;
        }
        
        .small-text {
            font-size: 6pt;
            line-height: 1.1;
        }
        
        .email-cell {
            word-break: break-all;
            font-size: 6.5pt;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="header-content">
        <div class="header">
            <img src="https://icta.go.ke/assets/images/ictalogo.png" class="logo" alt="ICTA Logo">
        </div>
        <div class="title">Apay Summit Gala Dinner Participants Report</div>
    </div>

    <!-- Summary -->
    <div class="summary">
        
        <strong>Report Summary:</strong> 
        {{ total_participants }} Participants • 
        Total Paid: {{ total_paid_all_users|ksh}} •  <!-- UPDATED: Added Total Paid -->
        Generated By: Apay Summit Gala Dinner Admin System on {{ report_date }}
    </div>

    <!-- Single Consolidated Table - LANDSCAPE OPTIMIZED -->
    <table>
        <thead>
            <tr>
                <th width="3%">#</th>
                <th width="12%">Participant Name</th>
                <th width="14%">Email</th>
                <th width="8%">Phone</th>
                <th width="10%">Registered By</th>
                <th width="6%" class="text-center">User's Total</th>
                <th width="10%">Invoice Number</th>
                <th width="8%">Status</th>
                <th width="7%" class="text-center">Amount</th>
                <th width="6%">Reg Date</th>
                <th width="8%">Payment Method</th>
                <th width="8%">Reference</th>
            </tr>
        </thead>
        <tbody>
            {% for participant in participants %}
            <tr {% if forloop.counter|divisibleby:2 %}class="alt"{% endif %}>
                <!-- Serial Number -->
                <td class="text-center compact-text">
                    <strong>{{ forloop.counter }}</strong>
                </td>
                
                <!-- Participant Name -->
                <td class="compact-text">
                    <strong>{{ participant.name }}</strong>
                </td>
                
                <!-- Email -->
                <td class="email-cell">
                    {{ participant.email }}
                </td>
                
                <!-- Phone -->
                <td class="compact-text">
                    {{ participant.phone }}
                </td>
                
                <!-- Registered By -->
                <td class="compact-text">
                    {{ participant.user.username }}
                    <br>
                    <span class="text-muted">{{ participant.user.email|truncatechars:20 }}</span>
                </td>
                
                <!-- User's Total Participants -->
                <td class="text-center">
                    {{ participant.user.participants.count }}
                </td>
                
                <!-- Invoice Number -->
                <td class="small-text">
                    {% with participant.invoice_list as invoices %}
                        {% if invoices %}
                            {% for invoice in invoices %}
                                {{ invoice.invoice_number }}
                            {% endfor %}
                        {% else %}
                            <span class="text-muted">No invoice</span>
                        {% endif %}
                    {% endwith %}
                </td>
                
                <!-- Status -->
                <td class="text-center">
                    {% with participant.invoice_list as invoices %}
                        {% if invoices %}
                            {% for invoice in invoices %}
                                <span class="badge 
                                    {% if invoice.status == 'paid' %}badge-success
                                    {% elif invoice.status == 'under_review' %}badge-info
                                    {% elif invoice.status == 'overdue' %}badge-danger
                                    {% else %}badge-warning{% endif %}">
                                    {{ invoice.get_status_display }}
                                </span>
                            {% endfor %}
                        {% else %}
                            <span class="badge badge-secondary">No Invoice</span>
                        {% endif %}
                    {% endwith %}
                </td>
                
                <!-- Amount -->
                <td class="text-center compact-text">
                    {% with participant.invoice_list as invoices %}
                        {% if invoices %}
                            {% for invoice in invoices %}
                                <strong>{{ invoice.total_amount|ksh }}</strong>
                            {% endfor %}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    {% endwith %}
                </td>
                
                <!-- Registration Date -->
                <td class="text-center small-text">
                    {{ participant.created_at|date:"m/d/y" }}
                </td>
                
                <!-- Payment Method -->
                <td class="small-text">
                    {% with participant.invoice_list as invoices %}
                        {% if invoices %}
                            {% for invoice in invoices %}
                                {% if invoice.payment_method %}
                                    {{ invoice.get_payment_method_display }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    {% endwith %}
                </td>
                
                <!-- Payment Reference -->
                <td class="small-text">
                    {% with participant.invoice_list as invoices %}
                        {% if invoices %}
                            {% for invoice in invoices %}
                                {% if invoice.payment_reference %}
                                    {{ invoice.payment_reference|truncatechars:15 }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    {% endwith %}
                </td>
            </tr>
            {% endfor %}
            
            <!-- Total Row -->
            <tr class="total-row">
                <td colspan="3" class="text-center">
                    <strong>GRAND TOTALS</strong>
                </td>
                <td colspan="2" class="text-center">
                    <strong>{{ total_participants }} Participants</strong>
                </td>
                <td colspan="2" class="text-center">
                    <strong>Total Paid: {{ total_paid_all_users|ksh }}</strong> 
                </td>
            </tr>
        </tbody>
    </table>

    <!-- Footer -->
    <div id="footer-content">
        <div class="footer">
            <strong>ICTA - Information and Communication Technology Authority</strong> | 
            Apay Summit Gala Dinner Registration System | Page <pdf:pagenumber> of <pdf:pagecount> 
        </div>
    </div>
</body>
</html>